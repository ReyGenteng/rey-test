<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RobuxNow.xyz - Jual Robux Terpercaya</title>
<meta name="keywords" content="beli robux, robux murah, jual robux, robux terpercaya, roblox, top up robux, robux aman, robux instant, robux preorder, robuxnow, robux now, robux ku, robux sekarang">
<meta name="description" content="RobuxNow.xyz adalah situs terpercaya untuk membeli Robux dengan harga termurah dan proses tercepat. Kami menyediakan berbagai metode top up Robux yang aman dan resmi. Kunjungi kami untuk pengalaman jual beli Robux yang terjamin asli dan aman.">
<link rel="icon" type="image/x-icon" href="https://reygenteng.github.io/reybelirbx/favicon.ico">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Styling Dasar dan Background */
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #0e1e26, #1a2a33, #253942); /* Gradien lebih gelap dan halus */
        color: #e5e7eb; /* Warna teks lebih terang */
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        transition: background-color 0.3s;
    }
    .container {
        max-width: 500px;
        width: 100%;
        background-color: rgba(255, 255, 255, 0.05); /* Sedikit lebih transparan */
        backdrop-filter: blur(8px);
        border-radius: 1.5rem;
        padding: 2rem;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.4); /* Shadow lebih kuat */
        animation: fadeIn 0.8s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.1); /* Garis tepi halus */
    }
    h1 {
        font-size: 2.5rem;
        font-weight: 800;
        color: #ffc107; /* Emas yang lebih cerah */
        text-shadow: 0 0 15px rgba(255, 193, 7, 0.7);
        margin-bottom: 0.5rem;
    }
    .text-center { text-align: center; }
    
    /* Input dan Tombol */
    input {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        outline: none;
        transition: all 0.3s;
    }
    input:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.3);
    }
    button {
        background: linear-gradient(135deg, #ffc107, #ffa000); /* Gradien tombol utama */
        color: #1a2a33;
        font-weight: 700;
    }
    button:hover:not(:disabled) {
        transform: translateY(-3px); /* Efek hover lebih kentara */
        box-shadow: 0 8px 20px rgba(255, 160, 0, 0.4);
    }

    /* Kontainer Status dan Info */
    .status-container, .transaction-info {
        background-color: rgba(255, 255, 255, 0.08); /* Kontainer lebih menonjol */
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .status-container {
        margin-top: 2rem;
        padding-top: 1rem;
    }
    .transaction-info span {
        color: #ffeb3b; /* Warna nilai data */
    }
    
    /* QR Code Display */
    #qrCodeDisplay {
        transition: opacity 0.5s ease-out; /* Transisi untuk menghilangkan QR */
    }
    #qrisImage {
        border: 4px solid #fff; /* Bingkai putih untuk QR */
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    
    /* History List */
    #historyList {
        max-height: 250px;
        overflow-y: auto;
        padding-right: 8px; /* Ruang untuk scrollbar */
    }
    /* Style untuk item history di dalam historyList */
    #historyList .transaction-info {
        background-color: rgba(0, 0, 0, 0.2);
        padding: 0.75rem;
        border-radius: 0.75rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #ffc107;
    }
    
    /* Status Labels */
    .status-pending { background-color: rgba(255, 193, 7, 0.3); color: #ffc107; }
    .status-processing { background-color: rgba(13, 110, 253, 0.3); color: #82b1ff; }
    .status-paid { background-color: rgba(40, 167, 69, 0.3); color: #4caf50; }
    .status-expired { background-color: rgba(220, 53, 69, 0.3); color: #ff8a80; }

    /* Button Group */
    .button-group button {
        background: linear-gradient(135deg, #1e3a8a, #3b82f6); /* Warna biru untuk Cek Status */
        color: #fff;
    }
    #cancelDepositBtn {
        background: linear-gradient(135deg, #ef4444, #dc2626) !important; /* Merah untuk Batalkan */
    }
    #clearHistoryBtn {
        background: linear-gradient(135deg, #6b7280, #4b5563); /* Abu-abu untuk Bersihkan Riwayat */
    }

    /* Countdown */
    .countdown {
        color: #ffeb3b; /* Warna kuning agar lebih terlihat */
    }

    @keyframes fadeIn { 
        from { opacity: 0; transform: scale(0.95); } 
        to { opacity: 1; transform: scale(1); } 
    }
    
    @media (max-width: 640px) {
        /* Penyesuaian responsif */
    }
</style>
</head>
<body>

<div class="container">
    <div class="text-center">
        <h1>RobuxNow.xyz</h1>
        <p class="text-gray-300">Pembayaran Cepat & Aman dengan QRIS</p>
    </div>

    <div class="input-group mt-6 p-4 rounded-xl bg-white/10">
        <label for="nominalInput" class="input-label text-white font-semibold">Nominal Deposit (IDR)</label>
        <input type="number" id="nominalInput" placeholder="Minimal Rp 10.000" min="10000" step="1000" class="input">
        <button id="createDepositBtn" class="mt-4">
            <span id="createText">Buat Kode QRIS Sekarang!</span>
            <span id="createLoading" class="loader" style="display: none;"></span>
        </button>
        <p class="expiry-info text-center mt-2">Batas waktu pembayaran: <span id="expiryTimeInfo">15 menit</span></p>
    </div>

    <div id="statusContainer" class="status-container">
        <h2 class="text-xl font-bold text-center mb-4 text-white">Status Transaksi</h2>
        
        <div id="paymentStatus" class="payment-status status-pending">Menunggu Pembayaran</div>
        
        <div id="countdown" class="countdown"></div>
        
        <div id="qrCodeDisplay" class="text-center mb-4">
            </div>
        
        <div id="transactionInfo" class="transaction-info">
            <p>Status: <span>Menunggu...</span></p>
            <p>Nominal: <span>Rp 0</span></p>
        </div>
        
        <p class="text-center text-sm mb-2 text-gray-400">ID Transaksi Aktif:</p>
        <p id="transactionId" class="text-center text-lg font-bold mb-4 text-yellow-300 break-all"></p>
        
        <div class="button-group">
            <button id="checkStatusBtn">
                <span id="checkText">Cek Status Terbaru</span>
                <span id="checkLoading" class="loader" style="display: none;"></span>
            </button>
            <button id="cancelDepositBtn">
                <span id="cancelText">Batalkan Transaksi</span>
                <span id="cancelLoading" class="loader" style="display: none;"></span>
            </button>
        </div>
    </div>

    <div id="historyContainer" class="status-container" style="margin-top: 2rem;">
        <h2 class="text-xl font-bold text-center mb-4 text-white">Riwayat Transaksi Terakhir</h2>
        <div id="historyList" class="space-y-3">
            <p class="text-center text-sm text-gray-500">Belum ada riwayat transaksi.</p>
        </div>
        <button id="clearHistoryBtn" class="mt-4 mx-auto block w-fit">
            üßπ Bersihkan Riwayat
        </button>
    </div>
    
</div>

<div id="message-box"></div>

<script>
    // Konstanta API Atlantic
    const KUNCI_API = 'ftS3uUCMOztd71uxhWp9MsVQchbBNQXLOcLJpkQW1W9aQg3gyXvUzJQkHW7bV54P6fKeWrzIWJf44nuuUh7xPTMQHY8lCtslMfez'; // Ganti dengan API key Atlantic Anda
    const URL_API_BASE = 'https://zproxy.officialardytc27.workers.dev?url=https://atlantich2h.com'; // Base URL Atlantic
    const URL_API_CREATE = URL_API_BASE + '/deposit/create';
    const URL_API_STATUS = URL_API_BASE + '/deposit/status';
    const URL_API_INSTANT = URL_API_BASE + '/deposit/instant';
    const URL_API_CANCEL = URL_API_BASE + '/deposit/cancel';
    
    // Waktu kadaluarsa dalam menit (Atlantic menggunakan 60 menit, kita pakai 15 menit agar lebih cepat)
    const WAKTU_KADALUARSA = 15;
    
    // Kunci LocalStorage
    const STORAGE_KEY = 'paymentHistory';

    // Elemen DOM (Singkat sebagian untuk kejelasan)
    const D = {
        inputNominal: document.getElementById('nominalInput'),
        tombolBuatDeposit: document.getElementById('createDepositBtn'),
        teksBuat: document.getElementById('createText'),
        loadingBuat: document.getElementById('createLoading'),
        kontainerStatus: document.getElementById('statusContainer'),
        tampilanKodeQR: document.getElementById('qrCodeDisplay'),
        tampilanIdTransaksi: document.getElementById('transactionId'),
        infoTransaksi: document.getElementById('transactionInfo'),
        statusPembayaran: document.getElementById('paymentStatus'),
        hitungMundurEl: document.getElementById('countdown'),
        tombolCekStatus: document.getElementById('checkStatusBtn'),
        teksCek: document.getElementById('checkText'),
        loadingCek: document.getElementById('checkLoading'),
        tombolBatalkan: document.getElementById('cancelDepositBtn'),
        teksBatal: document.getElementById('cancelText'),
        loadingBatal: document.getElementById('cancelLoading'),
        kotakPesan: document.getElementById('message-box'),
        infoWaktuKadaluarsa: document.getElementById('expiryTimeInfo'),
        historyList: document.getElementById('historyList'),
        clearHistoryBtn: document.getElementById('clearHistoryBtn')
    };

    // Variabel global
    let idTransaksiSaatIni = null;
    let intervalPolling = null;
    let intervalHitungMundur = null;
    let waktuKadaluarsa = null;
    let waktuSisa = WAKTU_KADALUARSA * 60; // dalam detik
    let sedangProsesInstant = false; 

    // Fungsi utilitas
    function tampilkanPesan(pesan, durasi = 3000, adalahError = false) {
        D.kotakPesan.textContent = pesan;
        D.kotakPesan.style.display = 'block';
        D.kotakPesan.style.background = adalahError ? '#dc2626' : '#16a34a';
        setTimeout(() => { D.kotakPesan.style.display = 'none'; }, durasi);
    }

    function formatRupiah(jumlah) {
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(jumlah);
    }

    function aturLoading(tombol, elemenTeks, elemenLoading, sedangLoading) {
        if (sedangLoading) {
            elemenTeks.style.display = 'none';
            elemenLoading.style.display = 'inline-block';
            tombol.disabled = true;
        } else {
            elemenTeks.style.display = 'inline';
            elemenLoading.style.display = 'none';
            tombol.disabled = false;
        }
    }

    // Fungsi Waktu
    function aturWaktuKadaluarsa() {
        waktuSisa = WAKTU_KADALUARSA * 60; 
        waktuKadaluarsa = new Date(Date.now() + waktuSisa * 1000);
        mulaiHitungMundur();
    }

    function mulaiHitungMundur() {
        clearInterval(intervalHitungMundur);
        perbaruiHitungMundur();
        intervalHitungMundur = setInterval(perbaruiHitungMundur, 1000);
    }

    function perbaruiHitungMundur() {
        if (waktuSisa <= 0) {
            clearInterval(intervalHitungMundur);
            D.hitungMundurEl.textContent = "Waktu pembayaran telah habis!";
            D.statusPembayaran.textContent = "Kadaluarsa";
            D.statusPembayaran.className = "payment-status status-expired";
            hapusKodeQR();
            return;
        }
        
        const menit = Math.floor(waktuSisa / 60).toString().padStart(2, '0');
        const detik = (waktuSisa % 60).toString().padStart(2, '0');
        
        D.hitungMundurEl.textContent = `‚è≥ Sisa waktu: ${menit}:${detik}`;
        waktuSisa--;
    }

    // [BARU] Fungsi menghilangkan QR code
    function hapusKodeQR() {
        D.tampilanKodeQR.style.opacity = '0';
        setTimeout(() => {
            D.tampilanKodeQR.innerHTML = '<p class="text-sm text-gray-500">QRIS sudah tidak ditampilkan.</p>';
            D.tampilanKodeQR.style.opacity = '1';
        }, 500); // Tunggu transisi opacity selesai
    }

    // Fungsi History LocalStorage
    function getHistory() {
        const history = localStorage.getItem(STORAGE_KEY);
        return history ? JSON.parse(history) : [];
    }
    
    function saveHistory(history) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
    }
    
    function addToHistory(transaction) {
        let history = getHistory();
        history = history.filter(tx => tx.id !== transaction.id);
        history.unshift(transaction);
        if (history.length > 10) { history.pop(); }
        saveHistory(history);
        renderHistory();
    }

    function updateHistoryStatus(id, newStatus) {
        let history = getHistory();
        const txIndex = history.findIndex(tx => tx.id === id);
        if (txIndex > -1) {
            history[txIndex].status = newStatus;
            saveHistory(history);
            renderHistory();
        }
    }

    function renderHistory() {
        const history = getHistory();
        if (history.length === 0) {
            D.historyList.innerHTML = '<p class="text-center text-sm text-gray-500">Belum ada riwayat transaksi.</p>';
            D.clearHistoryBtn.style.display = 'none';
        } else {
            D.historyList.innerHTML = history.map(tx => {
                const statusClass = tx.status === 'success' ? 'status-paid' : 
                                    tx.status === 'processing' ? 'status-processing' : 
                                    tx.status === 'cancel' || tx.status === 'expired' ? 'status-expired' : 'status-pending';
                                    
                return `
                    <div class="transaction-info flex justify-between items-center">
                        <div>
                            <p class="text-xs text-gray-400">ID: <span class="text-yellow-300 break-all">${tx.id}</span></p>
                            <p class="text-sm font-semibold">${formatRupiah(tx.nominal)}</p>
                            <p class="text-xs text-gray-500">${new Date(tx.date).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'})}</p>
                        </div>
                        <span class="${statusClass} text-xs py-1 px-2 rounded-full">${tx.status.toUpperCase()}</span>
                    </div>
                `;
            }).join('');
            D.clearHistoryBtn.style.display = 'block';
        }
    }
    
    D.clearHistoryBtn.addEventListener('click', () => {
        if (confirm('Yakin ingin menghapus semua riwayat? üò≤')) {
            localStorage.removeItem(STORAGE_KEY);
            renderHistory();
            tampilkanPesan('Riwayat berhasil dibersihkan! üßπ');
        }
    });

    // Fungsi API (disingkat)
    async function callApi(url, body) {
        const urlencoded = new URLSearchParams();
        urlencoded.append("api_key", KUNCI_API);
        for (const key in body) { urlencoded.append(key, body[key]); }

        const requestOptions = { method: 'POST', body: urlencoded, redirect: 'follow' };
        const response = await fetch(url, requestOptions);
        const data = await response.json();
        
        if (!response.ok || !data.status) {
            throw new Error(data.message || 'Gagal terhubung ke API');
        }
        return data;
    }

    // Fungsi Utama
    D.tombolBuatDeposit.addEventListener('click', async () => {
        const nominal = parseInt(D.inputNominal.value);
        if (isNaN(nominal) || nominal < 1000) {
            tampilkanPesan('Nominal minimal Rp 1.000!', 3000, true);
            return;
        }

        aturLoading(D.tombolBuatDeposit, D.teksBuat, D.loadingBuat, true);

        try {
            const data = await callApi(URL_API_CREATE, {
                reff_id: "deposit_" + Date.now(),
                nominal: nominal.toString(),
                type: "ewallet",
                metode: "qris"
            });
            
            idTransaksiSaatIni = data.data.id;
            
            // 1. Simpan ke History & Update URL
            const newTransaction = { id: idTransaksiSaatIni, nominal: data.data.nominal, status: data.data.status, date: new Date().toISOString() };
            addToHistory(newTransaction);
            window.history.pushState({ id: idTransaksiSaatIni }, `Transaksi ${idTransaksiSaatIni}`, `?id=${idTransaksiSaatIni}`);
            
            // 2. Tampilkan QR
            D.tampilanIdTransaksi.textContent = idTransaksiSaatIni;
            D.tampilanKodeQR.innerHTML = `
                <p class="text-sm mb-2 text-gray-400">Scan QR code berikut:</p>
                <img id="qrisImage" src="${data.data.qr_image}" alt="QRIS Code" class="mx-auto w-1/2 rounded-lg">
                <p class="text-sm mt-4 text-gray-400">Atau gunakan kode berikut (Raw Data):</p>
                <textarea class="w-full bg-black/30 text-white p-2 rounded mt-1 text-xs" rows="3" readonly>${data.data.qr_string}</textarea>
            `;
            
            // 3. Tampilkan Info Transaksi
            D.infoTransaksi.innerHTML = `
                <p>Status: <span>${data.data.status}</span></p>
                <p>Nominal: <span>${formatRupiah(data.data.nominal)}</span></p>
                <p>Dibuat: <span>${data.data.created_at}</span></p>
                <p>Kadaluarsa: <span>${data.data.expired_at}</span></p>
            `;
            
            // 4. Mulai Hitung Mundur & Polling
            aturWaktuKadaluarsa();
            D.kontainerStatus.style.display = 'block';
            tampilkanPesan('‚úÖ Kode QRIS berhasil dibuat!');
            clearInterval(intervalPolling);
            intervalPolling = setInterval(cekStatusPembayaran, 10000);
            
        } catch (error) {
            console.error('Error:', error);
            tampilkanPesan(`‚ùå Error: ${error.message}`, 5000, true);
        } finally {
            aturLoading(D.tombolBuatDeposit, D.teksBuat, D.loadingBuat, false);
        }
    });

    async function cekStatusPembayaran() {
        if (!idTransaksiSaatIni) return;

        try {
            const data = await callApi(URL_API_STATUS, { id: idTransaksiSaatIni });
            const status = data.data.status;
            
            // Update UI
            D.statusPembayaran.textContent = status.toUpperCase();
            D.statusPembayaran.className = "payment-status " + (
                status === 'success' ? 'status-paid' :
                status === 'processing' ? 'status-processing' :
                status === 'cancel' ? 'status-expired' : 'status-pending'
            );
            
            updateHistoryStatus(idTransaksiSaatIni, status); // Update history
            
            if (status === 'success') {
                // [FITUR BARU] Sembunyikan QR code jika sukses
                hapusKodeQR();
                clearInterval(intervalPolling);
                clearInterval(intervalHitungMundur);
                D.hitungMundurEl.textContent = "ü•≥ Pembayaran berhasil!";
                tampilkanPesan('üí∞ Pembayaran sukses! Saldo telah ditambahkan.', 5000);
                
                // Update info transaksi lengkap
                D.infoTransaksi.innerHTML = `
                    <p>Status: <span>${data.data.status}</span></p>
                    <p>Nominal: <span>${formatRupiah(data.data.nominal)}</span></p>
                    <p>Biaya Admin: <span>${formatRupiah(parseInt(data.data.fee))}</span></p>
                    <p>Saldo Diterima: <span>${formatRupiah(parseInt(data.data.get_balance))}</span></p>
                    <p>Metode: <span>${data.data.metode}</span></p>
                `;
            } else if (status === 'processing' && !sedangProsesInstant) {
                // Panggil instant deposit
                try {
                    await callApi(URL_API_INSTANT, { id: idTransaksiSaatIni, action: "true" });
                } catch (error) { /* Ignore instant error for polling */ }
            } else if (status === 'cancel' || waktuSisa <= 0) {
                // Hentikan polling/countdown jika dibatalkan/kadaluarsa
                clearInterval(intervalPolling);
                clearInterval(intervalHitungMundur);
                hapusKodeQR();
                D.hitungMundurEl.textContent = status === 'cancel' ? "Dibatalkan!" : "Waktu habis!";
            }
        } catch (error) {
            console.error('Error memeriksa status:', error);
            // Non-fatal error, biarkan polling berlanjut
        }
    }

    D.tombolCekStatus.addEventListener('click', async () => {
        if (!idTransaksiSaatIni) { tampilkanPesan('Tidak ada transaksi aktif', 3000, true); return; }
        aturLoading(D.tombolCekStatus, D.teksCek, D.loadingCek, true);
        await cekStatusPembayaran();
        aturLoading(D.tombolCekStatus, D.teksCek, D.loadingCek, false);
    });

    D.tombolBatalkan.addEventListener('click', async () => {
        if (!idTransaksiSaatIni || D.statusPembayaran.textContent === 'SUCCESS' || D.statusPembayaran.textContent === 'CANCEL') {
            tampilkanPesan('Transaksi tidak dapat dibatalkan', 3000, true); return;
        }
        if (!confirm('Apakah Anda yakin ingin membatalkan transaksi ini?')) { return; }

        aturLoading(D.tombolBatalkan, D.teksBatal, D.loadingBatal, true);
        try {
            await callApi(URL_API_CANCEL, { id: idTransaksiSaatIni });
            D.statusPembayaran.textContent = "DIBATALKAN";
            D.statusPembayaran.className = "payment-status status-expired";
            updateHistoryStatus(idTransaksiSaatIni, 'cancel');
            clearInterval(intervalPolling);
            clearInterval(intervalHitungMundur);
            hapusKodeQR();
            D.hitungMundurEl.textContent = "Transaksi dibatalkan!";
            tampilkanPesan('Transaksi berhasil dibatalkan üëã');
        } catch (error) {
            tampilkanPesan(`‚ùå Error batal: ${error.message}`, 5000, true);
        } finally {
            aturLoading(D.tombolBatalkan, D.teksBatal, D.loadingBatal, false);
        }
    });

    // Inisialisasi Halaman
    function inisialisasiHalaman() {
        D.infoWaktuKadaluarsa.textContent = `${WAKTU_KADALUARSA} menit`;
        renderHistory();

        const urlParams = new URLSearchParams(window.location.search);
        const txId = urlParams.get('id');
        
        if (txId) {
            const history = getHistory();
            const txFromHistory = history.find(tx => tx.id === txId);
            
            if (txFromHistory) {
                tampilkanPesan(`Mengaktifkan transaksi ${txId}... ‚ö°`);
                idTransaksiSaatIni = txId;
                
                D.tampilanIdTransaksi.textContent = txId;
                D.infoTransaksi.innerHTML = `
                    <p>Status: <span>${txFromHistory.status}</span></p>
                    <p>Nominal: <span>${formatRupiah(txFromHistory.nominal)}</span></p>
                    <p>Dibuat: <span>${new Date(txFromHistory.date).toLocaleString('id-ID')}</span></p>
                `;
                
                D.kontainerStatus.style.display = 'block';
                D.hitungMundurEl.textContent = "‚è≥ Memeriksa status...";

                // Tidak bisa memuat QR code dan waktu kadaluarsa, jadi hanya cek status dari API
                cekStatusPembayaran();
                clearInterval(intervalPolling);
                intervalPolling = setInterval(cekStatusPembayaran, 10000);
            } else {
                 tampilkanPesan(`ID Transaksi ${txId} tidak ditemukan di riwayat lokal.`, 3000, true);
            }
        }
    }

    inisialisasiHalaman();
</script>
</body>
</html>
